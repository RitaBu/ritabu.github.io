<!DOCTYPE html>
<html lang="en">

    <head>
        <!-- Required meta tags -->
        <meta charset="utf-8">
        <meta name="viewport"
              content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <!-- Bootstrap CSS -->
        <link href="../css/bootstrap.min.css"
              rel="stylesheet">
        <link href="../css/style.css"
              rel="stylesheet">
    </head>

    <body>
        <div class='customAlert'>
            <p class='message'></p>
            <input type='button'
                   class='confirmButton'
                   value='Gerai'>
        </div>
        <div class="container-fluid header-top">
            <a href="../index.html">
            <img class="header_logo img-fluid" src="../img_lessons/100_small1.png">
        </a>
            <div class="progress-container">
                <ul style="text-align: center;">
                    <li>
                        <a href="level1-1.html">1</a>
                    </li>
                    <li>
                        <a href="level1-2.html">2</a>
                    </li>
                    <li>
                        <a href="level1-3.html">3</a>
                    </li>
                    <li>
                        <a href="level1-4.html">4</a>
                    </li>
                    <li>
                        <a href="level1-5.html">5</a>
                    </li>
                    <li>
                        <a href="level1-6.html">6</a>
                    </li>
                    <li>
                        <a class="active"
                           href="level1-7.html">7</a>
                    </li>
                    <li>
                        <a href="level1-8.html">8</a>
                    </li>
                    <li>
                        <a href="level1-9.html">9</a>
                    </li>
                    <li>
                        <a href="level1-10.html">10</a>
                    </li>
                </ul>
            </div>
        </div>
        <div class="container-fluid working-space">
            <div class="row"
                 style="padding: 10px;">
                <div class="col-md-5">
                    <h4>7. Vairas Vīķes Freibergas saldās uzvaras</h4>
                </div>
                <div class=" col-md-7"
                     id="task"> 
                    Bijusī Latvijas prezidente Vaira Vīķe-Freiberga ir īpaša personība. 
                    Šajā uzdevumā Tev jāatrod un jāsakārto viņas nozīmīgākie sasniegumi politikā, 
                    zinātnē un dzīvē. Uzdevums būs pabeigts, 
                    kad izmantosi visus blokus un iziesi līmeni spēlē, kuru izveidoji.
                </div>
                <div class="row"
                     style="padding: 10px">
                    <div class="col  ">
                        <div id="preview">
                            <div id="rating">
                            </div>
                            <div class="clouds">
                                <div class="l1">
                                    <div class="l2">
                                        <div class="avatar"></div>
                                        <div id="item"
                                             class="star"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="button-panel">
                            <button class="button-run btn btn-lg btn-secondary"
                                    onclick="runCode()">Starts </button>
                            <div class="hint-panel">
                                <ul> Norāde:
                                    <li>
                                        <a tabindex="0"
                                           href="javascript:void(0)"
                                           data-toggle="popover"
                                           data-placement="top"
                                           data-trigger="focus"
                                           title=""
                                           data-text="Lai sasniegtu dotos attēlus, varonim jāpalecas.">1</a>
                                    </li>
                                    <li>
                                        <a tabindex="0"
                                           href="javascript:void(0)"
                                           data-toggle="popover"
                                           data-placement="top"
                                           data-trigger="focus"
                                           title=""
                                           data-text="Vai atradi visus sasniegumus? Kopā tie ir astoņi.">2</a>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="col"
                         style="padding: 0 ;">
                        <div id="blocklyDiv">
                        </div>
                        <xml id="toolbox"
                             style="display: none">
                            <category name="Spēle"
                                      colour="330">
                                <block type="jump"></block>
                                <block type="walk"></block>
                                <block type="treasure"></block>
                                <block type="treasure_speed"></block>
                                <block type="select_treasure"></block>
                            </category>
                        </xml>
                    </div>
                    <div class="col-md-3 col-lg-2"
                         style="height: 70vh;">
                        <h5>Javascript kods: </h5>
                        <pre id="content_javascript">
                </pre>
                    </div>
                </div>
                <div class="next-modal">
                    <div class="modal fade"
                         id="nextModal"
                         tabindex="-1"
                         role="dialog"
                         aria-labelledby="nextModalLabel">
                        <div class="modal-dialog"
                             role="document">
                            <div class="modal-content">
                                <div class="modal-body">
                                    <div>
                                        <h3>Izdevās!</h3>

                                    </div>
                                    <div class="modal-buttons">
                                        <a href="#"
                                           class="btn btn-secondary"
                                           data-dismiss="modal">Doties atpakaļ uz uzdevumu</a>
                                        <a href="level1-8.html"
                                           class="btn btn-secondary">Nākamais uzdevums</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Optional JavaScript -->
            <!-- jQuery first, then Popper.js, then Bootstrap JS -->
            <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
                    integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
                    crossorigin="anonymous"></script>
            <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.11.0/umd/popper.min.js"
                    integrity="sha384-b/U6ypiBEHpOf/4+1nzFpr53nxSS+GLCkfwBdFNTxtclqqenISfwAzpKaMNFNmj4"
                    crossorigin="anonymous"></script>
            <script src="../js/bootstrap.min.js"></script>
            <script src="../js/blockly_compressed.js"></script>
            <script src="../js/javascript_compressed.js"></script>
            <script src="../js/blocks_compressed.js"></script>
            <script src="../msg/js/lv.js"></script>
            <script src="../js/main.js"></script>
            <script src="../js/vike.js"></script>
            <script>
                var workspace = Blockly.inject('blocklyDiv', {
                    toolbox: document.getElementById('toolbox'),
                    grid: {
                        spacing: 20,
                        length: 5,
                        colour: '#f2f2f2',
                        snap: true
                    },
                    trashcan: true
                });

                function toJavascript(event) {
                    var code = Blockly.JavaScript.workspaceToCode(workspace);
                    document.getElementById('content_javascript').innerHTML = code;
                }
                workspace.addChangeListener(toJavascript);
            </script>
            <script type="text/javascript">
                var $ken = $('.avatar');
                var $star = $('.star');
                var $kenPos;
                var $starPos;
                var countStars = 0;


                function runCode() {

                    var treasureCollection = [];
                    var i = 0;
                    var index = 0;

                    $('#preview').off('mousedown');
                    $(window).off('keydown');
                    reset();
                    // Generate JavaScript code and run it.
                    window.LoopTrap = 1000;
                    Blockly.JavaScript.INFINITE_LOOP_TRAP =
                        'if (--window.LoopTrap == 0) throw "Infinite loop.";\n';
                    var code = Blockly.JavaScript.workspaceToCode(workspace);
                    Blockly.JavaScript.INFINITE_LOOP_TRAP = null;
                    try {
                        if (code.length > 0) {
                            // console.log(code);
                            //console.log(treasureCollection);
                            eval(code);
                            if (treasureCollection.length > 0) {
                                $(".star").css("background-image", "url(../img_lessons/vike/" + treasureCollection[0] + ".png)")

                            } else {
                                alert('Trūkst sasnieguma');
                            }


                            function clickJump(action) {
                                if (action == "screen") {
                                    $('#preview').on('mousedown', function(e) {
                                        if (e.type == 'mousedown') {
                                            // addJumpClass();
                                            jump(index);
                                        }
                                    });

                                } else {
                                    $(window).keydown(function(e) {
                                        console.log(e.keyCode);
                                        if (e.keyCode == action) {
                                            // addJumpClass();
                                            jump(index);
                                        }
                                    });


                                }
                            }


                            function isStarllColision() {
                                //console.log($star.is(':visible'));
                                if ($star.is(':visible')) {
                                    $starPos = $star.offset();
                                    $kenPos = $ken.offset();
                                    return $starPos.left > $kenPos.left + 20 && $starPos.left < $kenPos.left + 70 ? true : false;

                                } else {
                                    return false;
                                }
                            };

                            function animTreasure(t) {
                                setTimeout(function() {
                                    $(t).hide();
                                }, 200);
                                index += 1;
                                if (treasureCollection[index]) {
                                    setTimeout(function() {
                                        $(t).css("background-image", "url(../img_lessons/vike/" + treasureCollection[index] + ".png)");
                                        $(t).show();
                                    }, 450);
                                }
                            }

                            function walk() {
                                var vavatar = document.getElementsByClassName('avatar');
                                vavatar[0].style.animationDuration = "0.5s";
                            }

                            function treasureSpeed(speed) {
                                var st = document.getElementsByClassName('star');
                                st[0].style.animationDuration = (speed / 10) + "s";
                            }

                            function treasureOn(x) {
                                var st = document.getElementsByClassName('star');
                                st[0].style.visibility = x;
                            }

                            function treasureCollect(treasure_name) {

                                treasureCollection[i] = treasure_name;
                                i += 1;
                            }


                            function jump(index) {
                                $ken.addClass('jump');
                                var explodeIfColision = setInterval(function() {
                                    if (isStarllColision()) {
                                        clearInterval(explodeIfColision);
                                        if (treasureCollection[index] == 'not1' || treasureCollection[index] == 'not2' || treasureCollection[index] == 'not3' || treasureCollection[index] == 'not4') {
                                            alert('Izvēlētais sasniegums nav pareizs. Nomaini to un mēģini vēlreiz')
                                        } else {
                                            countStars += 1;
                                            document.getElementById('rating').innerHTML = 'Savākti:' + countStars;
                                        }
                                        animTreasure('.star');
                                    }
                                    setTimeout(function() {
                                        $ken.removeClass('jump');
                                        clearInterval(explodeIfColision);
                                    }, 500);
                                    if (countStars == 8) {
                                        clearInterval(explodeIfColision);
                                        setTimeout(function() {
                                            $('#preview').css('background-image', 'url(../img_lessons/vike/final.png)');
                                            $('.clouds').hide();
                                        }, 500);
                                        setTimeout(function() {
                                            $('#nextModal').modal('show');
                                        }, 2000);
                                    }
                                }, 50);
                            };

                        } else {
                            alert('Pievienot bloku.');
                        }

                    } catch (e) {
                        alert('Kļūda! Lūdzu, pārbaudi blokus');
                    }
                }

                function reset() {
                    var vavatar = document.getElementsByClassName('avatar');
                    vavatar[0].style.animationDuration = "0";
                    var st = document.getElementsByClassName('star');
                    st[0].style.animationDuration = "0";
                    $('.star').show();
                    st[0].style.visibility = "hidden";
                    countStars = 0;
                    $('#rating').empty();
                    $('.clouds').show();
                }
            </script>
    </body>

</html>